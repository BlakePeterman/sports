---
title: "NFL Concussion Analysis"
format: html
---


```{r}
#Load Libraries
library(dplyr)
library(nflreadr)
library(ggplot2)
library(tidyr)
```


nflreadr contains a database of weekly injury reports. While some injuries can be short term and may not show up on an injury report, concussions will usually show up on at least 1 report. 

Since concussions can be long term injuries, a player might show up on multiple injury reports with the same concusison injury. 

Concussions should happen at at least the same rate in the playoffs as in the regular season. (Playoff games are generally more intense than regular season games so there could even be an argument for concussions being more common.) On the other hand, playoff games have higher stakes than most regular season games so players may be less likely to fully report their symptoms. 

Those misaligned incentives are also present in regular season games, where an injured player may lose their role on the team. The NFL has tried to fix this issue by using independent neurologists who have the authority to remove a player from the game for concussion screening.


```{r}
#Load Injury data from nflreadR

injury_df = load_injuries(2020)

injury_df = injury_df %>% mutate(
    concussion_report_ind   = ifelse(report_primary_injury == "Concussion", 1, 0),
    concussion_practice_ind = ifelse(practice_primary_injury == "Concussion", 1, 0),
    week_type               = ifelse(game_type == "REG", "REG", "Postseason")
)

concussion_df = injury_df %>% filter(concussion_practice_ind == 1) %>% 
    group_by(week_type, week) %>%
    summarise(num_concussions = sum(concussion_practice_ind))

```

This plot shows the number of instances "Concussion" shows up on the injury report. This is not equivalent to the number of unique concussions, since players may be on multiple injury reports with the same injury.

```{r}
ggplot(data = concussion_df, 
       aes(x = week, y = num_concussions, fill=week_type)) + geom_col() + 
        labs(
            y = "Number of Concussions",
            title = "Number of Concussions by Week (2020)"
        )
```

While the plot shows a drastic decline in the number of concussions, there are also a lot fewer playoff games. The next plot shows the rate of concussions per game in each week.


```{r}
#Weeks 1-3 were 16 game weeks, 4 had 15, 5-11 had 14, 
# Week 12 had 16, 13 had 15, 14-17 had 16
#Wild Card weekend had 6 games
#Divisional playoffs had 4
#Conference championships had 2
#Super Bowl = 1 game.
games_per_week = c(rep(16,3)
                 , rep(15,1)
                 , rep(14, 7)
                 , rep(16, 1)
                 , rep(15, 1)
                 , rep(16, 4)
                 , 6
                 , 4
                 , 2
                 , 1)
#Sort concussion_df by week
concussion_df <- concussion_df %>% arrange(week) 

#Calculate rate
concussion_df$concussion_rate <- concussion_df$num_concussions / games_per_week

ggplot(data = concussion_df, 
       aes(x = week, y = concussion_rate, fill=week_type)) + geom_col() + 
        labs(
            y = "Concussion per Game",
            title = "Concussions per Game by Week (2020)"
        )
```

Looking at the rate of concussions on the practice report on a per game basis for 2020, there is no longer a sharp decline at the start of the postseason.

# 2009 - 2024


```{r}
injury_seasons = c(2009:2024)
injury_df = load_injuries(injury_seasons)

injury_df = injury_df %>% mutate(
    concussion_report_ind   = ifelse(report_primary_injury == "Concussion", 1, 0),
    concussion_practice_ind = ifelse(practice_primary_injury == "Concussion", 1, 0),
    week_type               = ifelse(game_type == "REG", "REG", "Postseason")
)

concussion_df = injury_df %>% filter(concussion_practice_ind == 1) %>% 
    group_by(season, week_type, week) %>%
    summarise(num_concussions = sum(concussion_practice_ind))


```



```{r}
#Load in season game data to calculate concussions per play
plays_df = load_pbp(injury_seasons)

plays_df = plays_df %>% select(play_id, season_type, week, game_id) %>%
    mutate(year = as.double(substr(game_id, 1, 4)),
           season_type = ifelse(season_type == "POST", "Postseason", "REG")) %>%
    group_by(season_type, week, year) %>%
    summarise(
       num_plays = n()
    )

#Join in number of concussions
injury_per_play_df <- plays_df %>% left_join(concussion_df, by = join_by("week" == "week", "year" == "season")) %>%
    mutate(
        num_concussions = replace_na(num_concussions, 0), #NA for num_concussions means no concussions happend
        concussions_per_play = num_concussions / num_plays
    )
```

This plot shows the concussions per play per week for each season in the data:

```{r}
ggplot(data = injury_per_play_df, 
       aes(x = week, y = concussions_per_play, fill=season_type)) + geom_col() + 
        labs(
            y = "Concussion per Play",
            title = "Concussions per Play by Week (2009 - 2024)"
        ) + facet_wrap(~year)
```

# 2009 - 2020 - Regression Discontinuity Design

This section looks at using Regression Discontinuity Design to see if there are fewer concussions on injury reports per play in the playoffs vs. the regular season. 

The running variable is week of the season. For 2009-2020, weeks 1-17 were regular season weeks and weeks after 17 were postseason weeks. The following plot shows the average concussions per play for each week. A dotted line shows the cutoff between the regular season and the postseason. 

It appears that there is a linear increasing relationship in the regular season and a linear decreasing relationship in the postseason. It also appears to have a discontinuous jump at the threshold. 

```{r}
#Plot average per play rates

#Week 18 in 2021-2024 was still regular season. 

avg_pre2021_df <- injury_per_play_df %>% filter(year <= 2020) %>%
    group_by(week, season_type) %>%
    summarise(
        avg_concussions_per_play = mean(concussions_per_play)
    ) %>%
      mutate(threshold = ifelse(week >= 18, 1, 0))



ggplot(data = avg_pre2021_df, 
        aes(x = week, y = avg_concussions_per_play, color=season_type)) + geom_point() +
        geom_vline(xintercept = 17.5, linetype="dashed") + 
            labs(
            y = "Concussion per Play",
            title = "Average Concussions per Play by Week (including 2009 - 2024)"    
            ) +   stat_smooth(method = "lm", se = F)
```



```{r}
#Fit model
lm_same_slope <- lm(avg_concussions_per_play ~ threshold + I(week - 18), data = avg_pre2021_df)

summary(lm_same_slope) 

#But it looks like the slopes vary


lm_varying_slope <- lm(avg_concussions_per_play ~ threshold + I(week - 18) + threshold:I(week - 18), data = avg_pre2021_df)

summary(lm_varying_slope) 


```

Under both the varying slope and non-varying slope design, there is a statistically significant decrease in the average concussions per play in the postseason. This suggests that fewer concussions are diagnosed in the postseason due to the nature of the game being a win-or-go-home posteason game vs. regular season. 

The magnitude of the effect is between -0.00229 (slope varying) and -0.00389 (same slope). 1000 plays in the postseason result in 2-3 fewer concussions than 1000 plays in the regular season.

# Sensitivity Analyses

## Placebo Cutoff

If there is a causal effect on concussion rates between the regular season and postseason, then there shouldn't be an effect if we consider the threshold to happen during 2 weeks of the regular season. This sensitivity looks to see if that is true for 2 placebo cutoffs.
```{r}
#Placebo Cutoff #1 - random week
set.seed(9)
placebo_threshold_1 <- sample(4:15, 1)
print(placebo_threshold_1)
#Cutoff #2 - median week
placebo_threshold_2 <- median(1:21)
print(placebo_threshold_2)

```

```{r}
#Placebo 1 model
placebo_1_df <- avg_pre2021_df %>% mutate(season_type = ifelse(week >= placebo_threshold_1, "Postseason","REG"))

ggplot(data = placebo_1_df, 
        aes(x = week, y = avg_concussions_per_play, color=season_type)) + geom_point() +
        geom_vline(xintercept = placebo_threshold_1-0.5, linetype="dashed") + 
            labs(
            y = "Concussion per Play",
            title = "Average Concussions per Play by Week (including 2009 - 2024)"    
            ) +   stat_smooth(method = "lm", se = F)

ggplot(data = placebo_1_df, 
        aes(x = week, y = avg_concussions_per_play, color=season_type)) + geom_point() +
        geom_vline(xintercept = placebo_threshold_1-0.5, linetype="dashed") + 
            labs(
            y = "Concussion per Play",
            title = "Average Concussions per Play by Week (including 2009 - 2024)"    
            ) +   stat_smooth(method = "loess", se = F)

```

A linear model looks like there may be a discontinuity at the 1st placebo threshold, but a loess fit shows the opposite and the plot doesn't look like there is a discontinuity.

```{r}
lm_same_slope <- lm(avg_concussions_per_play ~ threshold + I(week - placebo_threshold_1), data = placebo_1_df)

summary(lm_same_slope) 

#But it looks like the slopes vary


lm_varying_slope <- lm(avg_concussions_per_play ~ threshold + I(week - placebo_threshold_1) + threshold:I(week - placebo_threshold_1), data = placebo_1_df)

summary(lm_varying_slope) 



```

The models show a statisticaly significant, but small, effect without varying slope. A same slope on both sides of the threshold isn't supported by the plots and the model that allows a different slope shows no statitstically significant effect at the 5% level. 


```{r}
#Placebo 1 model
placebo_2_df <- avg_pre2021_df %>% mutate(season_type = ifelse(week >= placebo_threshold_2, "Postseason","REG"))

ggplot(data = placebo_2_df, 
        aes(x = week, y = avg_concussions_per_play, color=season_type)) + geom_point() +
        geom_vline(xintercept = placebo_threshold_2-0.5, linetype="dashed") + 
            labs(
            y = "Concussion per Play",
            title = "Average Concussions per Play by Week (including 2009 - 2024)"    
            ) +   stat_smooth(method = "lm", se = F)

ggplot(data = placebo_2_df, 
        aes(x = week, y = avg_concussions_per_play, color=season_type)) + geom_point() +
        geom_vline(xintercept = placebo_threshold_2-0.5, linetype="dashed") + 
            labs(
            y = "Concussion per Play",
            title = "Average Concussions per Play by Week (including 2009 - 2024)"    
            ) +   stat_smooth(method = "loess", se = F)

```

A linear model looks like there may be a discontinuity at the 2nd placebo threshold, but a loess fit shows the opposite and the plot doesn't look like there is a discontinuity.

```{r}
lm_same_slope <- lm(avg_concussions_per_play ~ threshold + I(week - placebo_threshold_2), data = placebo_2_df)

summary(lm_same_slope) 

#But it looks like the slopes vary


lm_varying_slope <- lm(avg_concussions_per_play ~ threshold + I(week - placebo_threshold_2) + threshold:I(week - placebo_threshold_2), data = placebo_2_df)

summary(lm_varying_slope) 

lm_non_linear_slope <- lm(avg_concussions_per_play  ~ threshold + I(week - placebo_threshold_2) + I((week -placebo_threshold_2)^2) + threshold:I(week - placebo_threshold_2) +
       threshold:I((week - placebo_threshold_2)^2), data = placebo_2_df)

summary(lm_non_linear_slope) 



```

With varying slopes, there is still a staistically significant effect. That effect disappears when the model allows for non-linear slopes. The plot looks non-linear, so the non-linear model is likely more appropriate.

```{r}
# Next steps: 
# Add logic so only the first concussion for a player is used, but allow for players to have multiple concussions in a year?
# see how things have changed since the independent neuro doc was instituted (started late 2009, fully implemented in 2013)
    #Not causal estimate: Other things could cut down on the rate of concussions like tackling technique, increased penalties for risky tackles (e.g., Hit on Defenseless Receiver), better helmet technology (e.g., Guardian Caps)
```
